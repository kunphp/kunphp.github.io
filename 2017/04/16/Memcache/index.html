<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    
    <title>Memcache | k-blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    
      <link rel="icon" href="/favicon.png">
    

    <link rel="stylesheet" href="/css/style.css">

    <link rel="stylesheet" href="/js/google-code-prettify/tomorrow-night-eighties.min.css">

  </head>

  <body>

<header>
	<a id="logo" href="/" title="k-blog">
	<img src="/favicon.png" alt="k-blog"></a>
	
	
		<!--搜索栏-->
		<i class="js-toggle-search iconfont icon-search"></i>


<form class="js-search search-form search-form--modal" method="get" action="http://gushi.li" role="search">
	<div class="search-form__inner">
		<div>
			<i class="iconfont icon-search"></i>
			<input class="text-input" placeholder="Enter Key..." type="search">
		</div>
	</div>
</form>
	

	
		<!--侧边导航栏-->
		<a id="nav-toggle" href="#"><span></span></a>

<nav>
	<div class="menu-top-container">
		<ul id="menu-top" class="menu">
			
				
				<li class="current-menu-item">
					<a href="https://kunphp.github.io/" target="">首页</a>
				</li>
			
				
				<li class="current-menu-item">
					<a href="null" target="">闲弄</a>
				</li>
			
				
				<li class="current-menu-item">
					<a href="null" target="">杂</a>
				</li>
			
				
				<li class="current-menu-item">
					<a href="null" target="">我</a>
				</li>
			
		</ul>
	</div>
</nav>
	

</header>
<div class="m-header ">
	<section id="hero1" class="hero">
		<div class="inner">
		</div>
	</section>
	
		<figure class="top-image" data-enable=true></figure>
	
</div>

<!--文章列表-->
<div class="wrapper">
  
    <!--文章-->
<article>
	
  
    <h1 class="post-title" itemprop="name">
      Memcache
    </h1>
  

	<div class='post-body mb'>
		<h1 id="第一章-memcached-介绍"><a href="#第一章-memcached-介绍" class="headerlink" title="第一章:memcached 介绍"></a>第一章:memcached 介绍</h1><h2 id="1-1-memcached-是什么"><a href="#1-1-memcached-是什么" class="headerlink" title="1-1 memcached  是什么?"></a>1-1 memcached  是什么?</h2><blockquote>
<p>memcached Danga  公司开发的一款软件。</p>
<p>自由&amp;开放源码, 高性能 ,分布式的内存对象缓存系统</p>
</blockquote>
<p>官方网站：<a href="http://memcached.org/" target="_blank" rel="external">http://memcached.org/</a></p>
<h2 id="1-2-memcached-应用图解"><a href="#1-2-memcached-应用图解" class="headerlink" title="1-2 memcached  应用图解"></a>1-2 memcached  应用图解</h2><p>许多 Web应用都将数据保存到 RDBMS 中，应用服务器从中读取数据并在浏览器中显示。但随着数<br>据量的增大、访问的集中，就会出现 RDBMS的负担加重、数据库响应恶化、网站显示延迟等重大<br>影响。</p>
<p>这时就该 memcached 大显身手了。memcached 是高性能的分布式内存缓存服务器。一般的使用目的<br>是，通过缓存数据库查询结果，减少数据库访问次数，以提高动态Web应用的速度、提高可扩展性。</p>
<p><img src="http://on9lro4r3.bkt.clouddn.com/mem_clipboard.png" alt="image"></p>
<p>注 RDBMS:Relational Database Management System</p>
<hr>
<h1 id="第二章-memcached-基本使用"><a href="#第二章-memcached-基本使用" class="headerlink" title="第二章:memcached 基本使用"></a>第二章:memcached 基本使用</h1><h2 id="2-1-memcached-的特性"><a href="#2-1-memcached-的特性" class="headerlink" title="2-1 memcached 的特性"></a>2-1 memcached 的特性</h2><p>memcached 作为高速运行的分布式缓存服务器，具有以下的特点</p>
<ul>
<li>协议简单</li>
<li>基于 libevent的事件处理</li>
<li>内置内存存储方式</li>
<li>memcached 不互相通信的分布式</li>
</ul>
<p><strong>协议简单</strong></p>
<p>memcached 的服务器客户端通信并不使用复杂的 XML等格式，而使用简单的基于文本行的协议。<br>因此，通过 telnet也能在memcached 上保存数据、取得数据。</p>
<p>举个栗子</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ telnet localhost <span class="number">11211</span></div><div class="line">Trying <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>...</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>命令</th>
<th>介绍</th>
</tr>
</thead>
<tbody>
<tr>
<td>set foo 0 0 3</td>
<td>（保存命令）</td>
</tr>
<tr>
<td>bar</td>
<td>（数据）</td>
</tr>
<tr>
<td>STORED</td>
<td>（结果）</td>
</tr>
<tr>
<td>get foo</td>
<td>（取得命令）</td>
</tr>
<tr>
<td>VALUE foo 0 3</td>
<td>（数据）</td>
</tr>
<tr>
<td>bar</td>
<td>（数据）</td>
</tr>
</tbody>
</table>
<h2 id="2-2-window-下-memcache-安装"><a href="#2-2-window-下-memcache-安装" class="headerlink" title="2-2 window 下 memcache 安装"></a>2-2 window 下 memcache 安装</h2><p>打开cmd，用cd命令 切换至memcache目录下 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">## 一步完成安装</span></div><div class="line">memcached.exe <span class="_">-d</span>   install </div><div class="line"></div><div class="line"><span class="comment">## 卸载</span></div><div class="line">memcached.exe <span class="_">-d</span>   uninstall</div></pre></td></tr></table></figure>
<h2 id="2-3-window-下-memcache-启动"><a href="#2-3-window-下-memcache-启动" class="headerlink" title="2-3 window 下 memcache 启动"></a>2-3 window 下 memcache 启动</h2><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">## 普通启动</div><div class="line">memcached -d start   </div><div class="line"></div><div class="line">## 监听端口启动</div><div class="line">memcached -p <span class="number">11212</span></div><div class="line"></div><div class="line">## 启动 memcache 端口<span class="number">11211</span> 给他分配<span class="number">32</span>M内存并且打印操作信息</div><div class="line">memcache.exe -p <span class="number">11211</span> -m <span class="number">32</span> -vv</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>命令</th>
<th>介绍</th>
</tr>
</thead>
<tbody>
<tr>
<td>-p <num></num></td>
<td>监听的TCP端口 (缺省: 11211)</td>
</tr>
<tr>
<td>-d</td>
<td>以守护进程方式运行Memcached</td>
</tr>
<tr>
<td>-u <username></username></td>
<td>运行Memcached的账户，非root用户</td>
</tr>
<tr>
<td>-m <num></num></td>
<td>最大的内存使用, 单位是MB，缺省是 64 MB</td>
<td></td>
</tr>
<tr>
<td>-c <num></num></td>
<td>软连接数量, 缺省是 1024</td>
</tr>
<tr>
<td>-v</td>
<td>输出警告和错误信息</td>
</tr>
<tr>
<td>-vv</td>
<td>打印客户端的请求和返回信息</td>
</tr>
<tr>
<td>-h</td>
<td>打印帮助信息</td>
</tr>
<tr>
<td>-i</td>
<td>打印memcached和libevent的版权信息</td>
</tr>
</tbody>
</table>
<h2 id="2-4-window-下-memcache-简单操作"><a href="#2-4-window-下-memcache-简单操作" class="headerlink" title="2-4 window 下 memcache 简单操作"></a>2-4 window 下 memcache 简单操作</h2><p><strong>1. telnet操作memcache</strong></p>
<p>确保本地已经安装 telnet </p>
<p>安装步骤：</p>
<p>控制面板==&gt;程序==&gt;启用或关闭windows功能==&gt;Telnet客户端</p>
<p>打开 cmd ,使用telnet 连接至memcache</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">telnet  <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>  <span class="number">11211</span></div></pre></td></tr></table></figure>
<p><strong>2. 数据存储命令</strong></p>
<p>a. set 命令<br>    格式：set key flag expiretime bytes</p>
<pre><code>说明：有则改无则增
</code></pre><p>举个栗子<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">set username <span class="number">0</span> <span class="number">0</span> <span class="number">4</span></div></pre></td></tr></table></figure></p>
<p>注：最后一位是字节，那么在输入存如内容时，大小必须是2个字节，否则存储不成功。</p>
<p>b. add 命令<br>    格式：add key flag expiretime bytes</p>
<pre><code>说明：add与set一致，区别是不能添加已经存在一个key为username的数据，否则不成功。
</code></pre><p>举个栗子<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">add username <span class="number">0</span> <span class="number">0</span> <span class="number">4</span></div></pre></td></tr></table></figure></p>
<p><strong>数据修改命令</strong></p>
<p>a. replace 命令<br>    格式: replace key flag expiretime bytes</p>
<pre><code>说明：replace与set一致，区别是只有数据存在时才能进行数据更新，如果replace一个不存在的key的数据，则replace不成功。
</code></pre><p>举个栗子<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">replace username <span class="number">0</span> <span class="number">0</span> <span class="number">4</span></div><div class="line">```    </div><div class="line">    </div><div class="line">    </div><div class="line">**数据读取命令**</div><div class="line"></div><div class="line">a. get命令 </div><div class="line">    格式： get <span class="type">key</span></div><div class="line">    </div><div class="line">    说明：get空格<span class="type">key</span> 可以获取指定<span class="type">key</span>的数据。多个<span class="type">key</span>可以用空格隔开</div><div class="line"></div><div class="line">举个栗子</div></pre></td></tr></table></figure></p>
<p>get username<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">**数据删除命令**</div><div class="line">a. <span class="keyword">delete</span>命令</div><div class="line">    格式：<span class="keyword">delete</span> <span class="built_in">key</span> </div><div class="line">    </div><div class="line">    说明：删除已存在的键值和不存在的记录可以返回不同的结果。</div><div class="line">举个栗子</div></pre></td></tr></table></figure></p>
<p>delete username<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="selector-tag">b</span>. 清空所有数据 flush_all [time]</div><div class="line"></div><div class="line">举个栗子</div></pre></td></tr></table></figure></p>
<p>flush_all[60]<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">注： <span class="built_in">time</span>参数是指是所有缓存失效,并在<span class="built_in">time</span>秒内限制使用删除的<span class="built_in">key</span></div><div class="line"></div><div class="line">**其他命令**</div><div class="line"></div><div class="line">a. 增减: incr/decr <span class="built_in">key</span> value</div><div class="line">举个栗子</div></pre></td></tr></table></figure></p>
<p>incr age 1<br>decr age 1<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">b. 服务器状态命令 stats</div><div class="line"></div><div class="line">名称 | 解释</div><div class="line">---|---</div><div class="line">STAT pid <span class="number">22459</span> | 进程ID </div><div class="line">STAT uptime <span class="number">1027046</span> |服务器运行秒数  </div><div class="line">STAT time <span class="number">1273043062</span>| 服务器当前unix时间戳 </div><div class="line">STAT version <span class="number">1.4</span><span class="number">.4</span> | 服务器版本  </div><div class="line">STAT pointer_size <span class="number">64</span>|操作系统字大小(<span class="number">64</span>位) </div><div class="line">STAT total_connections <span class="number">82</span>|曾打开的连接总数  </div><div class="line">STAT cmd_get <span class="number">54</span>|执行get命令总数  </div><div class="line">STAT cmd_set <span class="number">34</span>|执行set命令总数 </div><div class="line">STAT cmd_flush |指向flush_all命令总数  </div><div class="line">STAT get_hits <span class="number">9</span>|get命中次数 </div><div class="line">STAT get_misses <span class="number">45</span>|get未命中次数</div><div class="line">STAT delete_misses <span class="number">5</span>|delete未命中次数</div><div class="line">STAT delete_hits <span class="number">1</span>|delete命中次数</div><div class="line">STAT accepting_conns <span class="number">1</span> | 目前接受的链接数 </div><div class="line">STAT bytes <span class="number">0</span> | 存储item字节数</div><div class="line">STAT curr_items <span class="number">0</span> | item个数</div><div class="line">STAT evictions <span class="number">0</span> | 为获取空间删除item的总数</div><div class="line"></div><div class="line"></div><div class="line">---</div><div class="line">**名词解释**</div><div class="line"></div><div class="line"><span class="type">key</span>是什么?  （add/replace/set 的第一个参数）</div><div class="line">- <span class="type">key</span>是缓存名  memcached的一个重要特点就是<span class="type">key</span>-value缓存</div><div class="line">即键值对缓存.  每个缓存有一个独特的名字和存储空间. </div><div class="line">- <span class="type">key</span>是操作数据的唯一标识</div><div class="line">- <span class="type">key</span>可以<span class="number">250</span>个字节以内，不能有空格和控制字节</div><div class="line"></div><div class="line"></div><div class="line">flag有什么用?  （add/replace/set 的第二个参数）</div><div class="line"></div><div class="line">flag是<span class="string">"标志"</span>的意思,可以用此参数来标志内容的类型</div><div class="line">对于字符串,直接存<span class="number">5</span>个字符即可, 对于array,则需要序列化.</div></pre></td></tr></table></figure></p>
<p>Q：取出数据时,又如何处理呢?</p>
<p>A：字符串,取回直接用, 数组,则需要反序列化成数组.<br><figure class="highlight http"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="dockerfile">提示:在memcache中可以忽略flag参数memcache自动识别</span></div><div class="line"></div><div class="line">expire是啥（<span class="keyword">add</span><span class="bash">/replace/<span class="built_in">set</span> 的第三个参数）</span></div><div class="line"></div><div class="line">说明：过期时间 可以为时间戳 也可以是秒数 默认是<span class="number">0</span> 永久有效（其实并不是永久有效,下面会给大家说）</div></pre></td></tr></table></figure></p>
<p>Q：expire以什么为单位?</p>
<p>A：秒为单位<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<p>Q：expire的秒数代表什么?</p>
<p>A：如果expire&lt;=30<em>24</em>60*60,则代表自当前时间的偏移，即有效期在 time()+expire以内.<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">如果expire &gt;<span class="number"> 30 </span>*<span class="number"> 24 </span>*<span class="number"> 60 </span>*<span class="number"> 60 </span>,则直接代表时间戳.</div><div class="line"></div><div class="line">即,在1970年+expire秒以内有效.</div><div class="line"></div><div class="line"><span class="comment"># 第三章:Linux 平台下搭建 memcached 服务</span></div><div class="line"></div><div class="line"><span class="comment">## 3-1 编译安装 Memcached 服务</span></div><div class="line"></div><div class="line">在 linux 编译,需要 gcc,make,cmake,autoconf,libtool 等工具,所以请先装.</div><div class="line">【Linux 系统需联网】,命令安装</div></pre></td></tr></table></figure></p>
<h1 id="yum-install-gcc-make-cmake-autoconf-libtool"><a href="#yum-install-gcc-make-cmake-autoconf-libtool" class="headerlink" title="yum install gcc make cmake autoconf libtool"></a>yum install gcc make cmake autoconf libtool</h1><figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">memcached 依赖于 libevent 库,因此我们需要先安装 libevent.</div><div class="line"></div><div class="line">分别到 libevent.org 和 memcached.org 下载最新的 stable 版本(稳定版).</div><div class="line"></div><div class="line">libevent 官网：http://libevent.org</div><div class="line"></div><div class="line">[<span class="string">下载地址</span>](<span class="link">https://github.com/libevent/libevent/releases/download/release-2.1.8-stable/libevent-2.1.8-stable.tar.gz</span>)(Github地址)</div><div class="line"></div><div class="line">编译安装 libevent</div></pre></td></tr></table></figure>
<p>wget <a href="https://github.com/libevent/libevent/releases/download/release-2.1.8-stable/libevent-2.1.8-stable.tar.gz" target="_blank" rel="external">https://github.com/libevent/libevent/releases/download/release-2.1.8-stable/libevent-2.1.8-stable.tar.gz</a></p>
<p>tar zxvf libevent-2.0.21-stable.tar.gz<br>cd libevent-2.0.21-stable<br>./configure –prefix=/usr/local/libevent<br>make &amp;&amp; make install<br><figure class="highlight http"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="groovy">再编译安装 memcached</span></div><div class="line"></div><div class="line">Memcached 官网：<span class="string">http:</span><span class="comment">//memcached.org/</span></div><div class="line"></div><div class="line">编译 memcached 时要指定 libevent 的路径.</div></pre></td></tr></table></figure></p>
<p>wget <a href="http://www.memcached.org/files/memcached-1.4.36.tar.gz" target="_blank" rel="external">http://www.memcached.org/files/memcached-1.4.36.tar.gz</a></p>
<p>tar zxvf memcached-1.4.36.tar.gz<br>./configure –prefix=/usr/local/memcached –with-libevent=/usr/local/libevent/<br>make &amp;&amp; make install</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="attribute">memcached</span> 的启动</div><div class="line">从终端输入以下命令，启动 memcached。</div></pre></td></tr></table></figure>
<h1 id="usr-local-memcached-bin-memcached-p-11211-m-64m-u-root-vv"><a href="#usr-local-memcached-bin-memcached-p-11211-m-64m-u-root-vv" class="headerlink" title="/usr/local/memcached/bin/memcached -p 11211 -m 64m -u root -vv"></a>/usr/local/memcached/bin/memcached -p 11211 -m 64m -u root -vv</h1><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">作为 daemon 后台启动时，只需 `-d`</div></pre></td></tr></table></figure>
<h1 id="usr-local-memcached-bin-memcached-p-11211-m-64m-u-root-d"><a href="#usr-local-memcached-bin-memcached-p-11211-m-64m-u-root-d" class="headerlink" title="/usr/local/memcached/bin/memcached -p 11211 -m 64m -u root -d"></a>/usr/local/memcached/bin/memcached -p 11211 -m 64m -u root -d</h1><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">这里使用的 memcached 启动选项的内容如下。</div><div class="line"></div><div class="line">选项 | 说明</div><div class="line">-<span class="ruby">--<span class="params">|---</span></span></div><div class="line">-<span class="ruby"><span class="params">p |</span> 使用的 TCP端口。默认为 <span class="number">11211</span></span></div><div class="line">-<span class="ruby">m <span class="params">| 最大内存大小。默认为64M</span></span></div><div class="line">-<span class="ruby"><span class="params">vv|</span> 用 very vrebose 模式启动，调试信息和错误输出到控制台</span></div><div class="line">-<span class="ruby">d <span class="params">| 作为 daemon 在后台启动</span></span></div><div class="line"></div><div class="line">上面四个是常用的启动选项，其他还有很多，通过</div></pre></td></tr></table></figure>
<h1 id="usr-local-memcached-bin-memcached-h"><a href="#usr-local-memcached-bin-memcached-h" class="headerlink" title="/usr/local/memcached/bin/memcached -h"></a>/usr/local/memcached/bin/memcached -h</h1><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">命令可以显示。许多选项可以改变 memcached 的各种行为，推荐读一读。</div><div class="line"></div><div class="line"></div><div class="line">*<span class="strong">*常出现问题一*</span><span class="strong">*: </span></div><div class="line"></div><div class="line">在虚拟机下练习编译,一个容易碰到的问题---虚拟机的时间不对,</div><div class="line">导致的 gcc 编译过程中,检测时间通不过,一直处于编译过程.</div><div class="line"></div><div class="line">解决方法:</div></pre></td></tr></table></figure>
<h1 id="date-s-‘yyyy-mm-dd-hh-mm-ss’"><a href="#date-s-‘yyyy-mm-dd-hh-mm-ss’" class="headerlink" title="date -s ‘yyyy-mm-dd hh:mm:ss’"></a>date -s ‘yyyy-mm-dd hh:mm:ss’</h1><h1 id="clock-w-把时间写入-cmos"><a href="#clock-w-把时间写入-cmos" class="headerlink" title="clock -w  # 把时间写入 cmos"></a>clock -w  # 把时间写入 cmos</h1><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">*<span class="strong">*常出现问题二*</span><span class="strong">*:</span></div></pre></td></tr></table></figure>
<p>[root@iZ2ze2mkw2q2od0ctv8jnfZ memcached]# bin/memcached<br>can’t run as root without the -u switch<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">解释：没有指定- u开关不能作为根用户运行</div><div class="line"></div><div class="line"></div><div class="line">## <span class="number">3</span><span class="number">-2</span> Memcache 服务的安全</div><div class="line"></div><div class="line">此时本地客户端Telnet或php程序就可以连接至线上Memcache，没有任何的验证过程，这样如果服务器是直接暴露在互联网上的话是比较危险，轻则数据泄露被其他无关人员查看，重则服务器被入侵。</div><div class="line"></div><div class="line"></div><div class="line">解决方案</div><div class="line"></div><div class="line">**<span class="number">1.</span> 内网访问**</div><div class="line"></div><div class="line">把两台服务器之间的访问是内网形态的，一般是Web服务器跟Memcache服务器之间。。普遍的服务器都是有两块网卡，一块指向互联网，一块指向内网，那么就让Web服务器通过内网的网卡来访问Memcache服务器，</div><div class="line"></div><div class="line">Memcache的服务器上启动的时候就监听内网的IP地址和端口。</div></pre></td></tr></table></figure></p>
<h1 id="memcached-d-m-1024-u-root-l-127-0-0-1-p-11211-c-1024-P-tmp-memcached-pid"><a href="#memcached-d-m-1024-u-root-l-127-0-0-1-p-11211-c-1024-P-tmp-memcached-pid" class="headerlink" title="memcached -d -m 1024 -u root -l 127.0.0.1 -p 11211 -c 1024 -P /tmp/memcached.pid"></a>memcached -d -m 1024 -u root -l 127.0.0.1 -p 11211 -c 1024 -P /tmp/memcached.pid</h1><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">启动监听内网的<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>的ip的<span class="number">11211</span>端口，占用<span class="number">1024</span>MB内存，并且允许最大<span class="number">1024</span>个并发连接</div><div class="line"></div><div class="line">**<span class="number">2.</span> 设置防火墙**</div><div class="line"></div><div class="line">如若必可避免暴漏在外网，防火墙是简单有效的方式，那么可以考虑使用防火墙来过滤非法访问。</div><div class="line"></div><div class="line">一般我们在Linux下可以使用iptables或者FreeBSD下的ipfw来指定一些规则防止一些非法的访问。</div></pre></td></tr></table></figure>
<h1 id="iptables-F"><a href="#iptables-F" class="headerlink" title="iptables -F"></a>iptables -F</h1><h1 id="iptables-P-INPUT-DROP"><a href="#iptables-P-INPUT-DROP" class="headerlink" title="iptables -P INPUT DROP"></a>iptables -P INPUT DROP</h1><h1 id="iptables-A-INPUT-p-tcp-s-192-168-0-2-–dport-11211-j-ACCEPT"><a href="#iptables-A-INPUT-p-tcp-s-192-168-0-2-–dport-11211-j-ACCEPT" class="headerlink" title="iptables -A INPUT -p tcp -s 192.168.0.2 –dport 11211 -j ACCEPT"></a>iptables -A INPUT -p tcp -s 192.168.0.2 –dport 11211 -j ACCEPT</h1><h1 id="iptables-A-INPUT-p-udp-s-192-168-0-2-–dport-11211-j-ACCEPT"><a href="#iptables-A-INPUT-p-udp-s-192-168-0-2-–dport-11211-j-ACCEPT" class="headerlink" title="iptables -A INPUT -p udp -s 192.168.0.2 –dport 11211 -j ACCEPT"></a>iptables -A INPUT -p udp -s 192.168.0.2 –dport 11211 -j ACCEPT</h1><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">上面的iptables规则就是只允许<span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span>这台Web服务器对Memcache服务器的访问，能够有效的阻止一些非法访问，相应的也可以增加一些其他的规则来加强安全性，这个可以根据自己的需要来做。</div><div class="line"></div><div class="line"></div><div class="line">## <span class="number">3</span><span class="number">-3</span> Linux 上编译 memcached 扩展</div><div class="line"></div><div class="line"></div><div class="line">### <span class="number">3</span><span class="number">-3</span><span class="number">-1</span> 编译安装 libmemcached </div><div class="line"></div><div class="line">安装基础依赖库</div></pre></td></tr></table></figure>
<p>yum -y install gcc gcc-c++ libstdc++-devel<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">libmemcached 官网 `http:<span class="comment">//libmemcached.org/libMemcached.html`</span></div><div class="line"></div><div class="line"></div><div class="line">编译安装</div></pre></td></tr></table></figure></p>
<p>wget <a href="https://launchpad.net/libmemcached/1.0/1.0.18/+download/libmemcached-1.0.18.tar.gz" target="_blank" rel="external">https://launchpad.net/libmemcached/1.0/1.0.18/+download/libmemcached-1.0.18.tar.gz</a></p>
<p>tar libmemcached-1.0.18.tar.gz<br>tar zxvf libmemcached-1.0.18.tar.gz<br>cd libmemcached-1.0.18<br>./configure –prefix=/usr/local/libmemcached<br>make &amp;&amp; make install<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">### <span class="number">3</span><span class="number">-3</span><span class="number">-2</span> 编译安装 memcached </div><div class="line"></div><div class="line">下载 Memcached 扩展包</div><div class="line">下载地址：http:<span class="comment">//pecl.php.net/package/memcached</span></div></pre></td></tr></table></figure></p>
<p>wget <a href="http://pecl.php.net/get/memcached-3.0.3.tgz" target="_blank" rel="external">http://pecl.php.net/get/memcached-3.0.3.tgz</a><br>tar memcached-3.0.3.tgz<br>tar zxvf memcached-3.0.3.tgz<br>cd memcached-3.0.3</p>
<p>/usr/local/php/bin/phpize </p>
<p>./configure –with-php-config=/usr/local/php/bin/php-config –with-libmemcached-dir=/usr/local/libmemcached/ –disable-memcached-sasl</p>
<p>make &amp;&amp; make install</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="undefined">如果看到如下结果，那么恭喜您。</span></div></pre></td></tr></table></figure>
<p>[root@iZ2ze2mkw2q2od0ctv8jnfZ memcached-3.0.3]# make install<br>Installing shared extensions:     /usr/local/php/lib/php/extensions/no-debug-non-zts-20151012/</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">打开自己环境中的 `php.ini`，加入如下</div></pre></td></tr></table></figure>
<h1 id="vim-usr-local-php-lib-php-ini"><a href="#vim-usr-local-php-lib-php-ini" class="headerlink" title="vim /usr/local/php/lib/php.ini"></a>vim /usr/local/php/lib/php.ini</h1><p>extension=memcached.so<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">打印 <span class="code">`phpinfo()`</span>，<span class="code">`ctrl+f`</span> 搜索 memcached，看到如下</div><div class="line"></div><div class="line">![<span class="string">image</span>](<span class="link">http://on9lro4r3.bkt.clouddn.com/memcached.jpg</span>)</div><div class="line"></div><div class="line">至此，你的<span class="code">`PHP`</span>已支持<span class="code">`memcached`</span>收工。</div><div class="line"></div><div class="line"><span class="strong">**错误分析**</span></div></pre></td></tr></table></figure></p>
<p>configure: error: no, sasl.h is not available. Run configure with –disable-memcached-sasl to disable this check</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">按提示所说`--disable-memcached-sasl`禁用该选项即可。</div><div class="line"></div><div class="line">## <span class="number">3</span><span class="number">-3</span> Memcache 存储SESSION</div><div class="line"></div><div class="line">**方法I:** 在 php.ini 中全局设置</div></pre></td></tr></table></figure>
<p>session.save_handler = memcache<br>session.save_path = “tcp://127.0.0.1:11211”<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">*<span class="strong">*方法II：*</span>* 应用中动态更改配置：</div></pre></td></tr></table></figure></p>
<p>ini_set(“session.save_handler”, “memcache”);<br>ini_set(“session.save_path”,”tcp://127.0.0.1:11211”);<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">*<span class="strong">*方法III：*</span>* 项目目录下的 .htaccess</div></pre></td></tr></table></figure></p>
<p>php_value session.save_handler “memcache”<br>php_value session.save_path “tcp://127.0.0.1:11211”<br><figure class="highlight http"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="vala"><span class="meta"># 6-1 Memcache 的监控</span></span></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">## 6-1-1 memcache.php</span></div><div class="line"></div><div class="line">http:<span class="comment">//pecl.php.net/package/memcache</span></div><div class="line"></div><div class="line">从 memcache<span class="number">-3.0</span><span class="number">.8</span>.tgz 包中找到 memcache.php，拷贝至你的项目下,进行如下配置</div></pre></td></tr></table></figure></p>
<p>define(‘ADMIN_USERNAME’,’memcache’);     // Admin Username<br>define(‘ADMIN_PASSWORD’,’password’);      // Admin Password<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<p>$MEMCACHE_SERVERS[] = ‘mymemcache-server1:11211’; // add more as an array<br>$MEMCACHE_SERVERS[] = ‘mymemcache-server2:11211’; // add more as an array<br>```</p>
<p>不用多说，相信你懂的，完成以上配置后，访问（本宝宝的访问地址）：<a href="http://localhost/memcache.php" target="_blank" rel="external">http://localhost/memcache.php</a></p>
<p><img src="http://on9lro4r3.bkt.clouddn.com/memcached_2.jpg" alt="image"></p>
<h2 id="6-1-2-memcache-top"><a href="#6-1-2-memcache-top" class="headerlink" title="6-1-2 memcache-top"></a>6-1-2 memcache-top</h2><blockquote>
<p>这个工具memcache-top是一个perl脚本，可以运行在term下。它能够像top一样显示各个memcached节点的状态变化，其中包括系统管理员最关心的几个指数，例如：缓存命中率、内存、使用率、读写QPS等。</p>
</blockquote>
<p>运行前要确保memcache-top脚本具有可执行权限<br>chmod u+x *.sh    ，然后使用./执行即可。</p>
<p>memcache-top 比较重要的几个参数包括：</p>
<ul>
<li><p>–commands: 显示GETS/SETS命令的调用次数</p>
</li>
<li><p>–sleep: 刷新间隔，默认为3秒</p>
</li>
<li><p>–lifetime: 显示自memcached启动以来的累计统计值，默认关闭，即仅显示瞬时速率</p>
</li>
</ul>
<p><img src="http://on9lro4r3.bkt.clouddn.com/memcache-top.png" alt="image"></p>
<h2 id="6-1-3-memadmin"><a href="#6-1-3-memadmin" class="headerlink" title="6-1-3 memadmin"></a>6-1-3 memadmin</h2><blockquote>
<p>基于 PHP5 &amp; JQuery 的 Memcached 管理监控工具</p>
</blockquote>
<p>官方网址：<br><a href="http://www.junopen.com/memadmin/" target="_blank" rel="external">http://www.junopen.com/memadmin/</a></p>
<hr>

	</div>
	<div class="meta split">
		
			<span>本文总阅读量 <span id="busuanzi_value_page_pv"></span> 次</span>
		
		<time class="post-date" datetime="2017-04-16T06:09:40.000Z" itemprop="datePublished">2017-04-16</time>
	</div>
</article>

<!--评论-->

	
<div class="ds-thread" data-thread-key="Memcache" data-title="Memcache" data-url="http://yoursite.com/2017/04/16/Memcache/"></div>
<script type="text/javascript">

var duoshuoQuery = {short_name:"yumemor"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0]
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
</script>


  
</div>


  <svg id="bigTriangleColor" width="100%" height="40" viewBox="0 0 100 102" preserveAspectRatio="none">
    <path d="M0 0 L50 100 L100 0 Z"></path>
  </svg>

  


  <div class="wrapper"></div>





<div class="fat-footer">
	<div class="wrapper">
		<div class="layout layout--center">
			<div class="layout__item palm-mb">
				<div class="media">
					<img class="headimg" src='http://om733u7yz.bkt.clouddn.com/12.jpg' alt='Kun'>
					<div class="media__body">
						<h4>k-blog</h4>
						<p class='site-description'>null</p>
					</div>
				</div>
				<div class="author-contact">
					<ul>
						
							
							<li>
				        		<a href="http://weibo.com/5497648979/" target="_blank">
				        			
				        				<i class="iconfont icon-weibo"></i>
				        			
				        		</a>
				        	</li>
						
							
							<li>
				        		<a href="https://user.qzone.qq.com/1666845868/" target="_blank">
				        			
				        		</a>
				        	</li>
						
							
							<li>
				        		<a href="https://www.zhihu.com/people/yumemor" target="_blank">
				        			
										<i class="iconfont icon-zhihu"></i>
				        			
				        		</a>
				        	</li>
						
					</ul>
				</div>
			</div>
		</div>
	</div>
</div>

<footer class="footer" role="contentinfo">
	<div class="wrapper wrapper--wide split split--responsive">
		
			<span>本站总访问量 <span id="busuanzi_value_site_pv"></span> 次, 访客数 <span id="busuanzi_value_site_uv"></span> 人次</span>
		
		<span>Theme by <a href="http://github.com/kunphp">Kun</a>. Powered by <a href="http://hexo.io">Hexo</a></span>
	</div>
</footer>

	<!-－这里导入了 lib.js 里面涵盖了 jQuery 等框架 所以注释掉-->
	<!--<script src="http://lib.sinaapp.com/js/jquery/2.0/jquery.min.js"></script>-->
	<script src="/js/lib.js"></script>
	<script src="/js/google-code-prettify/prettify.js"></script>
	<script src="/js/module.js"></script>
	<script src="/js/script.js"></script>
	
		<script async src="http://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	
	<script type='text/javascript'>
		//代码高亮
		$(document).ready(function(){
	 		$('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto;');
   			prettyPrint();
		});
	</script>
	</body>
</html>
